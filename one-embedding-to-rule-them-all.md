# One Embedding to Rule Them All   
# One Embedding to Rule Them All   
Pinterest’s OmniSearchSage represents a major step forward in unified semantic search. By extending the two-tower model into a multi-task, multi-entity framework, it enables a single query embedding to power retrieval across pins, products, and related queries. The system integrates GenAI captions, user-curated board metadata, and behavioral signals to overcome sparse content, while maintaining compatibility with legacy models like PinSage. Deployed at massive scale, OmniSearchSage delivers strong gains in search fulfillment, ad performance, and downstream tasks, showcasing a pragmatic and scalable approach to representation learning in production.   
![6807c5aa8d6a68b022f228ac_Screenshot 2025-04-22 at 12.36.38 PM](files\6807c5aa8d6a68b022f228ac_screenshot-2025-04-22.png)    
April 22, 2025   
\|   
6   
min read   
by   
Tullie Murrell   
‍**A paper write up on "OmniSearchSage: Multi-Task Multi-Entity Embeddings for Pinterest Search",**  [Agarwal et al., WWW '24 Companion](https://arxiv.org/abs/2404.16260)   
Imagine searching Pinterest. You're not just typing keywords; you're looking for *inspiration*. Maybe it's "vintage living room ideas," "healthy weeknight meals," or "DIY bookshelf." Pinterest needs to understand the *intent* behind billions of such searches each month, connecting you with the perfect pins, products, videos, and even related query suggestions from a universe of billions of items, across more than 45 languages.   
The journey to achieve this level of understanding has been a long one in the field of information retrieval. Early search engines relied heavily on lexical matching – counting keyword occurrences (like TF-IDF or BM25). While effective to a degree, they often struggled with synonyms, related concepts, and understanding the true *semantics* behind a query. The advent of deep learning brought **embeddings** to the forefront – dense vector representations learned from data, pioneered by models like Word2Vec and GloVe for words, and later extended to sentences and documents with approaches like Universal Sentence Encoder and Sentence-BERT.   
This paved the way for **semantic search**, where queries and documents are mapped into a shared vector space, allowing retrieval based on conceptual similarity rather than just keyword overlap. A dominant paradigm in industry for scalable semantic search became the **two-tower model**, famously used in systems like YouTube recommendations ( [Covington et al., 2016](https://dl.acm.org/doi/10.1145/2959100.2959190)) and Facebook search ( [Huang et al., 2020](https://dl.acm.org/doi/10.1145/3394486.3403305)). In this setup, one "tower" encodes the query, another encodes the item (e.g., pin, product, document), and the model learns to bring relevant query-item pairs closer together in the embedding space.   
However, standard two-tower models face challenges in complex ecosystems like Pinterest. How do you handle multiple item types (pins, products, ads) efficiently? How do you enrich understanding when item descriptions are sparse or noisy? And how do you integrate smoothly with existing, specialized embedding systems? This is precisely the context where **OmniSearchSage**, developed by researchers at Pinterest ( [Agarwal et al., WWW '24 Companion](https://arxiv.org/abs/2404.16260)), makes its mark. It evolves the two-tower concept to address these real-world complexities, aiming to create a single, versatile query embedding.   
What makes the OmniSearchSage paper particularly compelling goes beyond its technical novelty. It stands out for delivering **exceptionally strong real-world results**, including a stunning **+7.4% cumulative uplift in search fulfillment**, a key business metric. Furthermore, it offers a refreshing dose of **engineering pragmatism**, openly discussing architectural choices that prioritized simplicity and integration over purely optimizing offline metrics – highlighting the real-world tradeoffs in production ML. Finally, its impact is broad; rather than being a point solution, OmniSearchSage serves as a **foundational query understanding framework** whose benefits cascade across retrieval, ranking, advertising, and other downstream applications, demonstrating the power of investing in core representation learning.   
Now, let's dive into the specific challenges Pinterest faced, the core ideas behind OmniSearchSage, and how they achieved these impressive outcomes.   
### The Core Idea: A Shared Semantic Space   
OmniSearchSage refines the two-tower concept by jointly learning a ***unified* query embedding** alongside pin and product embeddings, all residing *in the same vector space*. The goal remains to ensure relevant query embeddings (q\_x) and item embeddings (p\_y, pr\_z) are close (high cosine similarity: q\_x ⋅ p\_y). The key innovation is the unified nature of the query embedding, designed to be versatile across different downstream item types and tasks.   
How does OmniSearchSage build their versatile representation? It intelligently combines several techniques, drawing inspiration from established ideas while adding crucial, Pinterest-specific innovations.   
### 1. Beyond Keywords: Achieving Richer Content Understanding   
A core challenge on platforms like Pinterest is that items (pins or products) often lack detailed, high-quality textual descriptions. A pin might just be an image, or a product title might be generic. OmniSearchSage tackles this head-on by **systematically augmenting the available metadata**, moving far beyond simple titles and descriptions. This concept, broadly related to document expansion ( [Nogueira et al., 2019](https://arxiv.org/abs/1904.08375)), is adapted and enriched here:   
- **GenAI-Powered Descriptions:** Recognizing that a huge volume of pins (~30% in their dataset) lack *any* title or description, the team employed the **BLIP vision-language model** ( [Li et al., 2023](https://arxiv.org/abs/2301.12597)) to generate synthetic captions directly from the pin images. This provides universal text coverage, ensuring even purely visual content has a semantic anchor. Internal human evaluations found these captions to be relevant and high-quality nearly 88% of the time. Even though users don't see these captions directly, they provide vital semantic grounding for the model.   
- **Leveraging User Curation: Board Titles:** Pinterest users meticulously organize pins into thematic boards (e.g., "Modern Kitchen Ideas," "Fall Fashion Trends"). These board titles act as high-quality, human-generated labels reflecting the pin's topic or style. OmniSearchSage intelligently aggregates the titles of boards a pin has been saved to, selecting the top 10 most informative ones based on frequency, word prevalence, and length filtering to reduce noise. This taps into the collective intelligence of the user base, enriching item understanding with contextual semantics. A significant 91% of items had associated board titles.   
- **Learning from Interaction: Engaged Queries:** If many users click on or save a specific pin after searching for "DIY planter," that query itself is a strong indicator of the pin's relevance and topic. OmniSearchSage incorporates the top 20 queries that led to user engagement (like saves or long clicks) with each pin or product over a long (two-year) timeframe. This captures behavioral relevance signals and is kept fresh via an incremental update process. Around 65% of items had associated engagement queries.   
   
By combining the item's native text (if any) with these three complementary sources – AI-generated captions, user-curated board titles, and historical engagement queries – OmniSearchSage builds a much more comprehensive and nuanced understanding of each pin and product than would be possible otherwise.   
### 2. Learning Smarter, Not Just Harder: Multi-Task Learning and Compatibility   
![6807c61535bfbb4ccf83f787_Screenshot 2025-04-22 at 12.38.26 PM](files\6807c61535bfbb4ccf83f787_screenshot-2025-04-22.png)    
Having richer features is only part of the story. The system needs to learn how to use them effectively. Here, OmniSearchSage employs a sophisticated **Multi-Task Learning (MTL)** strategy ( [Ruder, 2017](https://ruder.io/multi-task/)):   
- **Simultaneous Objectives:** Instead of training separate models, the system learns the *single, unified query embedding* by simultaneously optimizing for multiple goals: predicting relevant **pins** for a query, predicting relevant **products** for a query, and predicting relevant **related queries** for a query. This encourages the query embedding to capture facets useful across all these related tasks, promoting generalization and efficiency.   
- **Handling Scale with Sampled Softmax:** With billions of potential items, calculating a standard softmax loss over all possible pins or products for every query is computationally impossible. OmniSearchSage treats the problem as extreme classification and uses a **sampled softmax loss**. For each positive query-item pair (x\_i, y\_i) in a training batch, the loss contrasts the score of the positive item (q\_{x\_i} ⋅ p\_{y\_i}) against scores of negative items. These negatives are cleverly sampled: they include other positive items within the same batch (in-batch negatives) and items randomly sampled from the global corpus.   
- **Debiasing with LogQ Correction:** Randomly sampling negatives isn't perfectly uniform; popular items are more likely to be picked. To prevent the model from unfairly penalizing relevance to popular items, the loss incorporates the **logQ correction** technique ( [Yi et al., 2019](https://dl.acm.org/doi/10.1145/3341105.3341146)). This adjusts the score contribution of each negative sample based on its sampling probability, leading to a more accurate representation of true relevance. The final training loss is the sum of these corrected sampled softmax losses across all tasks (query-pin, query-product, query-query).   
- **Pragmatism is Key: Compatibility Encoders:** This is a standout practical feature. Pinterest already had powerful, established embedding systems: **PinSage** ( [Ying et al., 2018](https://dl.acm.org/doi/10.1145/3219819.3219869)), a Graph Neural Network capturing pin-board relationships, and **ItemSage** ( [Baltescu et al., 2022](https://dl.acm.org/doi/10.1145/3534678.3539072)), specialized for product understanding. Replacing these entirely would be costly and discard years of work. OmniSearchSage cleverly includes **compatibility encoders** (likely simple projection layers trained alongside the main model) as part of its MTL setup. Their specific job is to ensure that the *new unified query embedding* q\_x remains semantically aligned and comparable (via dot product) with the *existing, pre-computed* PinSage and ItemSage embeddings. This allows the new query understanding to integrate seamlessly with legacy retrieval and ranking systems, enabling gradual rollout and leveraging existing strengths – a masterclass in practical ML deployment. The paper shows this compatibility was achieved with negligible impact on the primary task performance.   
   
### 3. Efficient Architecture for Production Scale   
![6807c6958fc0e5528f370dce_Screenshot 2025-04-22 at 12.40.38 PM](files\6807c6958fc0e5528f370dce_screenshot-2025-04-22.png)    
Underpinning these learning strategies is an architecture designed for both effectiveness and efficiency:   
- **Query Encoder:** Uses **multilingual DistilBERT**, a smaller, faster version of BERT, capable of handling queries in over 45 languages efficiently. The output embedding corresponding to the [CLS] token is projected down to the final 256 dimensions and **L2-normalized**. Normalization simplifies downstream similarity calculations to just a dot product, which is computationally cheaper.   
- **Unified Item Encoder:** A single encoder architecture processes both pins and products. It takes the diverse input features – native text, the enrichment signals (GenAI captions, board titles, engaged queries), and continuous features like PinSage/ItemSage/image embeddings. Text features are processed using **multiple tokenization strategies** (word unigrams, word bigrams, character trigrams) to capture different levels of textual detail. These tokens are then mapped into embeddings using **hash embeddings** (Svenstrup et al., 2017), a memory-efficient technique crucial for handling the massive vocabularies encountered in web-scale text without requiring huge lookup tables. All these feature embeddings are concatenated and fed through a **3-layer MLP** (with 1024 units per hidden layer) to learn complex interactions, followed by final **L2 normalization**. The paper notes that this relatively simple encoder design was chosen after ablation studies, balancing performance with training and serving efficiency.   
   
In essence, OmniSearchSage constructs its query representation by deeply understanding content through multiple lenses (native text, AI generation, user curation, user behavior), learning efficiently across multiple related tasks using sophisticated loss functions, and ensuring practical deployment through compatibility with existing systems and efficient architectural components. It’s a well-orchestrated symphony of techniques aimed at a single goal: truly understanding user intent at scale.   
### The Results   
OmniSearchSage demonstrated significant improvements over Pinterest's previous SearchSage system in offline evaluations (>60% gain for pins, ~27% for products, +44% for queries). Online A/B tests confirmed these gains, boosting organic search fulfillment (+7.4%) and relevance (+3.5%), as well as Ads CTR (+5%). The learned embeddings also enhanced downstream classification tasks (+30%). The system's scalability (300k QPS, 3ms median latency) proves its production-readiness.   
![6807c6e010caacfb0405bafe_Screenshot 2025-04-22 at 12.41.35 PM](files\6807c6e010caacfb0405bafe_screenshot-2025-04-22.png)    
### Why This Matters in the Broader Context   
OmniSearchSage stands out as a practical and powerful evolution of semantic search techniques. For **Pinterest users**, it translates academic advances into a noticeably better experience. For **AI practitioners**, it showcases how to effectively:   
- Extend the two-tower paradigm for multi-entity, multi-task scenarios.   
- Combine diverse signals (GenAI, user curation, behavior) for robust content understanding.   
- Apply MTL pragmatically, including ensuring backward compatibility.   
- Design for massive scale and efficiency.   
   
### Conclusion: A Step Forward in Unified World Understanding   
OmniSearchSage provides a compelling blueprint for building next-generation search systems in complex environments. By creating a unified semantic space centered around a versatile query embedding, Pinterest has developed a system that is architecturally simpler yet more powerful than relying on fragmented models. It elegantly integrates state-of-the-art techniques like large language/vision models, graph embeddings (via compatibility), and multi-task learning into a cohesive whole. The "one query embedding to rule them all" approach isn't just a catchy phrase; it represents a significant step towards truly unified and semantic information retrieval at scale.   
For the full technical details and implementation specifics, I highly recommend reading the [full paper](https://arxiv.org/abs/2404.16260) and exploring their [code implementation](https://github.com/pinterest/atg-research/tree/main/omnisearchsage).   
# Get up and running with one engineer in one sprint   
Guaranteed lift within your first 30 days or your money back   
[Get a Demo](https://www.shaped.ai/contact)   
100M+   
Users and items   
1000+   
Queries per second   
1B+   
Requests   
## Related Posts   
![67c78ae3ee270593bfd59782_Untitled design (12)](files\67c78ae3ee270593bfd59782_untitled-design-12.png)    
Tullie Murrell   
\|    
March 5, 2025   
**[Beyond Relevance: Optimizing for Multiple Objectives in Search and Recommendations](https://www.shaped.ai/blog/beyond-relevance-optimizing-for-multiple-objectives-in-search-and-recommendations)**   
![66f5061bce701370ef7a5813_GNN](files\66f5061bce701370ef7a5813_gnn.webp)    
